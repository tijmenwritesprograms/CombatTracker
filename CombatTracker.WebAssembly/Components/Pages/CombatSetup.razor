@page "/combat-setup"
@implements IDisposable

@using CombatTracker.WebAssembly.Models
@using CombatTracker.WebAssembly.Services
@inject PartyStateService PartyStateService
@inject CombatStateService CombatStateService
@inject NavigationManager NavigationManager
@inject StorageStateService StorageStateService

<PageTitle>Combat Setup - D&D Combat Tracker</PageTitle>

<h1>Combat Setup</h1>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-3">
            <div class="card-header">
                <h4>Party Selection</h4>
            </div>
            <div class="card-body">
                @if (parties.Count == 0)
                {
                    <div class="alert alert-warning" role="alert">
                        No parties available. Please <a href="/party-management">create a party</a> first.
                    </div>
                }
                else
                {
                    <div class="mb-3">
                        <label for="partySelect" class="form-label">Select Party</label>
                        <select id="partySelect" class="form-select" @onchange="OnPartySelected">
                            <option value="">-- Select a party --</option>
                            @foreach (var party in parties)
                            {
                                <option value="@party.Id">@party.Name (@party.Characters.Count characters)</option>
                            }
                        </select>
                    </div>
                }
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header">
                <h4>Add Monster</h4>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <button type="button" class="btn btn-success w-100" @onclick="OpenStatblockParser">
                        <i class="bi bi-magic"></i> Parse Statblock with AI
                    </button>
                    <div class="form-text text-center">
                        Automatically extract monster data from D&D 5e statblocks
                    </div>
                </div>

                <div class="text-center mb-3">
                    <small class="text-muted">— OR —</small>
                </div>

                <EditForm Model="@newMonster" OnValidSubmit="@HandleAddMonster">
                    <DataAnnotationsValidator />
                    <ValidationSummary class="text-danger" />

                    <div class="mb-3">
                        <label for="monsterName" class="form-label">Name</label>
                        <InputText id="monsterName" class="form-control" @bind-Value="newMonster.Name" />
                        <ValidationMessage For="@(() => newMonster.Name)" />
                    </div>

                    <div class="mb-3">
                        <label for="monsterType" class="form-label">Type</label>
                        <InputText id="monsterType" class="form-control" @bind-Value="newMonster.Type" />
                        <ValidationMessage For="@(() => newMonster.Type)" />
                    </div>

                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="monsterHp" class="form-label">HP</label>
                            <InputNumber id="monsterHp" class="form-control" @bind-Value="newMonster.Hp" />
                            <ValidationMessage For="@(() => newMonster.Hp)" />
                        </div>

                        <div class="col-md-3 mb-3">
                            <label for="monsterAc" class="form-label">AC</label>
                            <InputNumber id="monsterAc" class="form-control" @bind-Value="newMonster.AC" />
                            <ValidationMessage For="@(() => newMonster.AC)" />
                        </div>

                        <div class="col-md-3 mb-3">
                            <label for="monsterInitMod" class="form-label">Init Mod</label>
                            <InputNumber id="monsterInitMod" class="form-control" @bind-Value="newMonster.InitiativeModifier" />
                            <ValidationMessage For="@(() => newMonster.InitiativeModifier)" />
                        </div>

                        <div class="col-md-3 mb-3">
                            <label for="monsterCount" class="form-label">Count</label>
                            <InputNumber id="monsterCount" class="form-control" @bind-Value="monsterCount" min="1" />
                            <div class="form-text">Number of instances</div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">Add Monster(s)</button>
                <button type="button" class="btn btn-outline-danger ms-2" @onclick="AddOrcTestMonster">Add Orc (Test)</button>
                </EditForm>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card mb-3">
            <div class="card-header">
                <h4>Saved Monsters</h4>
            </div>
            <div class="card-body">
                @if (savedMonsters == null || savedMonsters.Count == 0)
                {
                    <p class="text-muted">No saved monsters. Parse a statblock and check "Save parsed monster" to add here.</p>
                }
                else
                {
                    <ul class="list-group mb-2">
                        @foreach (var sm in savedMonsters)
                        {
                            <li class="list-group-item">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <strong>@sm.Name</strong>
                                        <div class="small text-muted">@sm.Type • HP: @sm.Hp • AC: @sm.AC</div>
                                    </div>
                                    <button class="btn btn-sm btn-outline-danger" @onclick="() => RemoveSavedMonster(sm.Id)">Remove</button>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <input type="number" class="form-control form-control-sm" style="width: 80px;" 
                                           min="1" value="1" @onchange="@(e => savedMonsterCounts[sm.Id] = int.Parse(e.Value?.ToString() ?? "1"))" />
                                    <button class="btn btn-sm btn-primary" @onclick="() => AddSavedMonsterToCombat(sm)">Add to Combat</button>
                                </div>
                            </li>
                        }
                    </ul>
                }
            </div>
        </div>
        <div class="card mb-3">
            <div class="card-header">
                <h4>Combatants (@combatants.Count)</h4>
            </div>
            <div class="card-body">
                @if (combatants.Count == 0)
                {
                    <p class="text-muted">No combatants added yet. Select a party or add monsters.</p>
                }
                else
                {
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>HP</th>
                                <th>AC</th>
                                <th>Init Mod</th>
                                <th>Initiative</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var kvp in combatants)
                            {
                                var combatant = kvp.Value;
                                <tr>
                                    <td>@combatant.Name</td>
                                    <td>@combatant.Type</td>
                                    <td>@combatant.HpMax</td>
                                    <td>@combatant.AC</td>
                                    <td>@(combatant.InitiativeModifier >= 0 ? "+" : "")@combatant.InitiativeModifier</td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm" style="width: 80px;" 
                                               value="@combatant.Initiative" 
                                               @onchange="@(e => OnInitiativeChanged(kvp.Key, e.Value?.ToString()))" />
                                    </td>
                                    <td>
                                        @if (!combatant.IsCharacter)
                                        {
                                            <button class="btn btn-sm btn-danger" @onclick="() => RemoveMonster(combatant.ReferenceId)">
                                                Remove
                                            </button>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    <div class="mt-3">
                        <div class="btn-group me-2">
                            <button class="btn btn-secondary" @onclick="() => RollInitiative(false)">
                                <span class="bi bi-dice-5"></span> Roll Initiative
                            </button>
                            <button type="button" class="btn btn-secondary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                                <span class="visually-hidden">Toggle Dropdown</span>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" @onclick="() => RollInitiative(false)">Monsters</a></li>
                                <li><a class="dropdown-item" @onclick="() => RollInitiative(true)">All</a></li>
                            </ul>
                        </div>

                        <button class="btn btn-primary me-2" @onclick="StartCombat" disabled="@(!canStartCombat)">
                            <span class="bi bi-play-fill"></span> Start Combat
                        </button>
                        <button class="btn btn-outline-secondary" @onclick="ResetCombat">
                            <span class="bi bi-arrow-counterclockwise"></span> Reset
                        </button>
                    </div>

                    @if (!canStartCombat && combatants.Count > 0)
                    {
                        <div class="alert alert-warning mt-3" role="alert">
                            Add at least one combatant to start combat.
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>

<StatblockParserModal 
    IsOpen="@isStatblockParserOpen" 
    OnClose="@CloseStatblockParser" 
    OnMonsterParsedWithCount="@HandleMonsterParsedWithCount" />

@code {
    private List<Party> parties = new();
    private Dictionary<string, CombatantSetupData> combatants = new();
    private Monster newMonster = new() { Type = "Humanoid" };
    private int monsterCount = 1;
    private bool canStartCombat => CombatStateService.IsValidForCombat();
    private bool isStatblockParserOpen = false;

    private void AddOrcTestMonster()
    {
        var orc = new Monster
        {
            Name = "Orc",
            Size = "Medium",
            Type = "Humanoid",
            Subtype = "Orc",
            Alignment = "Chaotic Evil",
            AC = 13,
            ArmorType = "hide armor",
            Hp = 15,
            HpFormula = "2d8 + 6",
            Speed = 30,
            FlySpeed = 0,
            SwimSpeed = 0,
            ClimbSpeed = 0,
            BurrowSpeed = 0,
            Abilities = new AbilityScores
            {
                Strength = 16,
                Dexterity = 12,
                Constitution = 16,
                Intelligence = 7,
                Wisdom = 11,
                Charisma = 10
            },
            Skills = "Intimidation +2",
            SavingThrows = null,
            Vulnerabilities = null,
            Resistances = null,
            Immunities = null,
            ConditionImmunities = null,
            Senses = "Darkvision 60 ft., Passive Perception 10",
            Languages = "Common, Orc",
            ChallengeRating = "1/2",
            ExperiencePoints = 100,
            ProficiencyBonus = 2,
            InitiativeModifier = 1,
            Traits = new List<MonsterTrait>
            {
                new MonsterTrait
                {
                    Name = "Aggressive",
                    Description = "As a bonus action, the orc can move up to its speed toward a hostile creature that it can see."
                }
            },
            Actions = new List<MonsterAction>
            {
                new MonsterAction
                {
                    Name = "Greataxe",
                    Description = "Melee Weapon Attack: +5 to hit, reach 5 ft., one target. Hit: 9 (1d12 + 3) slashing damage.",
                    AttackType = "Melee Weapon Attack",
                    AttackBonus = 5,
                    Reach = 5,
                    DamageFormula = "1d12 + 3",
                    DamageType = "slashing"
                },
                new MonsterAction
                {
                    Name = "Javelin",
                    Description = "Melee or Ranged Weapon Attack: +5 to hit, reach 5 ft. or range 30/120 ft., one target. Hit: 6 (1d6 + 3) piercing damage.",
                    AttackType = "Melee or Ranged Weapon Attack",
                    AttackBonus = 5,
                    Reach = 5,
                    Range = "30/120",
                    DamageFormula = "1d6 + 3",
                    DamageType = "piercing"
                }
            },
            BonusActions = new List<MonsterAction>(),
            Reactions = new List<MonsterAction>(),
            LegendaryActions = new List<MonsterAction>(),
            LegendaryActionsPerRound = 0,
            LairActions = new List<MonsterAction>()
        };
        CombatStateService.AddMonster(orc);
        RefreshCombatants();
    }

    // OnAfterRenderAsync: initialization (moved lower to include saved-monsters loading)

    protected override void OnInitialized()
    {
        PartyStateService.OnChange += RefreshParties;
        CombatStateService.OnChange += RefreshCombatants;
    }

    private void OnPartySelected(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var partyId))
        {
            var party = PartyStateService.GetPartyById(partyId);
            CombatStateService.SelectParty(party);
        }
        else
        {
            CombatStateService.SelectParty(null);
        }
    }

    private void HandleAddMonster()
    {
        if (monsterCount <= 1)
        {
            CombatStateService.AddMonster(newMonster);
        }
        else
        {
            CombatStateService.AddMonsters(newMonster, monsterCount);
        }
        newMonster = new Monster { Type = "Humanoid" };
        monsterCount = 1;
    }

    private void RemoveMonster(int monsterId)
    {
        CombatStateService.RemoveMonster(monsterId);
    }

    private void RollInitiative(bool rollAll = false)
    {
        if (rollAll)
        {
            CombatStateService.RollInitiativeForAll();
        }
        else
        {
            CombatStateService.RollInitiativeForMonsters();
        }
    }

    private void OnInitiativeChanged(string combatantKey, string? value)
    {
        if (int.TryParse(value, out var initiative))
        {
            CombatStateService.SetInitiative(combatantKey, initiative);
        }
    }

    private void StartCombat()
    {
        if (canStartCombat)
        {
            CombatStateService.StartCombat();
            NavigationManager.NavigateTo("/combat-tracker");
        }
    }

    private void ResetCombat()
    {
        CombatStateService.Reset();
    }

    private void RefreshParties()
    {
        parties = PartyStateService.GetAllParties().ToList();
        StateHasChanged();
    }

    private void RefreshCombatants()
    {
        combatants = CombatStateService.Combatants;
        StateHasChanged();
    }

    private void OpenStatblockParser()
    {
        isStatblockParserOpen = true;
    }

    private void CloseStatblockParser()
    {
        isStatblockParserOpen = false;
    }

    private void HandleMonsterParsedWithCount((Monster Monster, int Count) data)
    {
        if (data.Count <= 1)
        {
            CombatStateService.AddMonster(data.Monster);
        }
        else
        {
            CombatStateService.AddMonsters(data.Monster, data.Count);
        }
        RefreshCombatants();
    }

    // Saved monsters (user library)
    private List<Monster> savedMonsters = new();
    private Dictionary<int, int> savedMonsterCounts = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await PartyStateService.InitializeAsync();
            await CombatStateService.InitializeAsync();
            RefreshParties();
            RefreshCombatants();
            // Load saved monsters library
            savedMonsters = await StorageStateService.LoadSavedMonstersAsync();
            StateHasChanged();
        }
    }

    private void AddSavedMonsterToCombat(Monster saved)
    {
        if (saved == null)
        {
            return;
        }

        var count = savedMonsterCounts.GetValueOrDefault(saved.Id, 1);
        var clone = CloneMonster(saved);
        
        if (count <= 1)
        {
            CombatStateService.AddMonster(clone);
        }
        else
        {
            CombatStateService.AddMonsters(clone, count);
        }
        
        RefreshCombatants();
    }

    private async Task RemoveSavedMonster(int savedId)
    {
        await StorageStateService.RemoveSavedMonsterAsync(savedId);
        savedMonsters = await StorageStateService.LoadSavedMonstersAsync();
        StateHasChanged();
    }

    private static Monster CloneMonster(Monster src)
    {
        if (src == null) return new Monster();

        Monster clone = new()
        {
            // Do not copy Id so CombatStateService assigns a new one
            Name = src.Name,
            Size = src.Size,
            Type = src.Type,
            Subtype = src.Subtype,
            Alignment = src.Alignment,
            AC = src.AC,
            ArmorType = src.ArmorType,
            Hp = src.Hp,
            HpFormula = src.HpFormula,
            Speed = src.Speed,
            FlySpeed = src.FlySpeed,
            SwimSpeed = src.SwimSpeed,
            ClimbSpeed = src.ClimbSpeed,
            BurrowSpeed = src.BurrowSpeed,
            Abilities = src.Abilities == null ? new AbilityScores() : new AbilityScores
            {
                Strength = src.Abilities.Strength,
                Dexterity = src.Abilities.Dexterity,
                Constitution = src.Abilities.Constitution,
                Intelligence = src.Abilities.Intelligence,
                Wisdom = src.Abilities.Wisdom,
                Charisma = src.Abilities.Charisma
            },
            Skills = src.Skills,
            SavingThrows = src.SavingThrows,
            Vulnerabilities = src.Vulnerabilities,
            Resistances = src.Resistances,
            Immunities = src.Immunities,
            ConditionImmunities = src.ConditionImmunities,
            Senses = src.Senses,
            Languages = src.Languages,
            ChallengeRating = src.ChallengeRating,
            ExperiencePoints = src.ExperiencePoints,
            ProficiencyBonus = src.ProficiencyBonus,
            InitiativeModifier = src.InitiativeModifier,
            Traits = src.Traits?.Select(t => new MonsterTrait { Name = t.Name, Description = t.Description }).ToList() ?? new List<MonsterTrait>(),
            Actions = src.Actions?.Select(a => new MonsterAction {
                Name = a.Name,
                Description = a.Description,
                AttackType = a.AttackType,
                AttackBonus = a.AttackBonus,
                Reach = a.Reach,
                Range = a.Range,
                DamageFormula = a.DamageFormula,
                DamageType = a.DamageType
            }).ToList() ?? new List<MonsterAction>(),
            BonusActions = src.BonusActions?.Select(a => new MonsterAction {
                Name = a.Name,
                Description = a.Description,
                AttackType = a.AttackType,
                AttackBonus = a.AttackBonus,
                Reach = a.Reach,
                Range = a.Range,
                DamageFormula = a.DamageFormula,
                DamageType = a.DamageType
            }).ToList() ?? new List<MonsterAction>(),
            Reactions = src.Reactions?.Select(a => new MonsterAction {
                Name = a.Name,
                Description = a.Description,
                AttackType = a.AttackType,
                AttackBonus = a.AttackBonus,
                Reach = a.Reach,
                Range = a.Range,
                DamageFormula = a.DamageFormula,
                DamageType = a.DamageType
            }).ToList() ?? new List<MonsterAction>(),
            LegendaryActions = src.LegendaryActions?.Select(a => new MonsterAction {
                Name = a.Name,
                Description = a.Description,
                AttackType = a.AttackType,
                AttackBonus = a.AttackBonus,
                Reach = a.Reach,
                Range = a.Range,
                DamageFormula = a.DamageFormula,
                DamageType = a.DamageType
            }).ToList() ?? new List<MonsterAction>(),
            LegendaryActionsPerRound = src.LegendaryActionsPerRound,
            LairActions = src.LairActions?.Select(a => new MonsterAction {
                Name = a.Name,
                Description = a.Description,
                AttackType = a.AttackType,
                AttackBonus = a.AttackBonus,
                Reach = a.Reach,
                Range = a.Range,
                DamageFormula = a.DamageFormula,
                DamageType = a.DamageType
            }).ToList() ?? new List<MonsterAction>()
        };

        return clone;
    }

    public void Dispose()
    {
        PartyStateService.OnChange -= RefreshParties;
        CombatStateService.OnChange -= RefreshCombatants;
    }
}
