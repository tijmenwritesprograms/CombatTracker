@using Models;


<tr class="@RowClass slide-in">
    <td>
        <InitiativeIndicator IsCurrentTurn="@IsCurrentTurn" />
    </td>
    <td>
        <InitiativeDisplay Initiative="@Initiative" />
    </td>
    <td class="@TextClass">
        <MonsterNameDisplay 
            Name="@($"{DisplayName} (×{GroupMembers.Count})")"
            ReferenceId="@ReferenceId"
            CombatantIndex="@GroupMembers.First().Instance.Index"
            IsExpanded="@IsQuickRefExpanded"
            OnShowStatblock="@OnShowStatblock"
            OnToggleQuickReference="@OnToggleQuickReference" />
    </td>
    <td class="@TextClass">@Type</td>
    <td>
        <div class="d-flex flex-column gap-1" style="min-width: 150px;">
            @foreach (var member in GroupMembers)
            {
                <div>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="@(member.Instance.Status != Status.Alive ? "text-decoration-line-through text-muted" : "")">
                            #@member.Data.InstanceNumber: @member.Instance.HpCurrent / @member.Data.HpMax
                        </small>
                        @if (member.Instance.HpCurrent <= 0)
                        {
                            <span class="badge bg-danger" style="font-size: 0.6rem;">0 HP</span>
                        }
                        else if (member.Instance.HpCurrent < member.Data.HpMax / 2)
                        {
                            <span class="badge bg-warning" style="font-size: 0.6rem;">Bloodied</span>
                        }
                    </div>
                    @if (member.Instance.HpCurrent > 0)
                    {
                        var hpPercent = (int)((double)member.Instance.HpCurrent / member.Data.HpMax * 100);
                        <div class="hp-bar" style="height: 6px; margin-top: 2px;" title="HP: @member.Instance.HpCurrent / @member.Data.HpMax">
                            <div class="hp-bar-fill" style="width: @hpPercent%"></div>
                        </div>
                    }
                </div>
            }
        </div>
    </td>
    <td class="@TextClass">
        <ArmorClassDisplay ArmorClass="@AC" />
    </td>
    <td>
        <div class="d-flex flex-column gap-2">
            @foreach (var member in GroupMembers)
            {
                <StatusBadge Status="@member.Instance.Status" />
            }
        </div>
    </td>
    <td>
        <div class="flex-column gap-2">
            @foreach (var member in GroupMembers)
            {
                <CombatantActions 
                    CombatantIndex="@member.Instance.Index" 
                    IsAlive="@(member.Instance.Status == Status.Alive)" 
                    OnDamage="@OnDamage" 
                    OnHeal="@OnHeal" />
            }
        </div>
    </td>
</tr>

@code {
    [Parameter, EditorRequired]
    public List<(CombatantInstance Instance, CombatantSetupData Data)> GroupMembers { get; set; } = null!;

    [Parameter, EditorRequired]
    public bool IsCurrentTurn { get; set; }

    [Parameter]
    public bool IsQuickRefExpanded { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<int> OnDamage { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<int> OnHeal { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<int> OnShowStatblock { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<int> OnToggleQuickReference { get; set; }

    private string RowClass => IsCurrentTurn ? "table-primary" : "";
    
    private string TextClass
    {
        get
        {
            var allDead = GroupMembers.All(m => m.Instance.Status != Status.Alive);
            return allDead ? "text-decoration-line-through text-muted" : "";
        }
    }

    private int Initiative => GroupMembers.First().Instance.Initiative;
    private int ReferenceId => GroupMembers.First().Data.ReferenceId;
    private string Type => GroupMembers.First().Data.Type;
    private int AC => GroupMembers.First().Data.AC;
    
    private string DisplayName
    {
        get
        {
            var name = GroupMembers.First().Data.Name;
            // Remove instance number from name if present
            var lastSpace = name.LastIndexOf(' ');
            if (lastSpace > 0 && int.TryParse(name.Substring(lastSpace + 1), out _))
            {
                name = name.Substring(0, lastSpace);
            }
            return name;
        }
    }
}
